<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标记K线图</title>
    <script type="text/javascript" src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            position: relative;
            height: 800px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            margin-bottom: 20px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-count {
            color: #666;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>标记K线图</h1>
        <div id="legend" class="legend"></div>
        <div class="chart-container" id="chart"></div>
    </div>

    <script>
        class MarkedChart {
            constructor() {
                this.chart = null;
                this.candlestickSeries = null;
                this.volumeSeries = null;
                this.markStats = {};
            }

            initialize() {
                const container = document.getElementById('chart');
                
                // 创建图表
                this.chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: {
                        background: { color: '#ffffff' },
                        textColor: '#333333',
                    },
                    grid: {
                        vertLines: { color: '#f0f0f0' },
                        horzLines: { color: '#f0f0f0' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#dcdee0',
                    },
                    timeScale: {
                        borderColor: '#dcdee0',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                // 创建K线图
                this.candlestickSeries = this.chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });

                // 创建成交量图
                this.volumeSeries = this.chart.addHistogramSeries({
                    color: '#26a69a',
                    priceFormat: {
                        type: 'volume',
                    },
                    priceScaleId: '',
                    scaleMargins: {
                        top: 0.8,
                        bottom: 0,
                    },
                });

                // 加载数据
                this.loadData();

                // 窗口大小改变事件
                window.addEventListener('resize', () => this.handleResize());
            }

            getMarkerColor(mark) {
                // 根据标记值生成颜色
                if (mark > 0) {
                    // 上涨标记使用绿色系
                    const intensity = Math.min(Math.max(Math.abs(mark) * 5, 50), 255);
                    return `rgb(0, ${intensity}, 0)`;
                } else {
                    // 下跌标记使用红色系
                    const intensity = Math.min(Math.max(Math.abs(mark) * 5, 50), 255);
                    return `rgb(${intensity}, 0, 0)`;
                }
            }

            updateLegend() {
                const legend = document.getElementById('legend');
                legend.innerHTML = '';

                // 将标记按绝对值大小排序
                const sortedMarks = Object.entries(this.markStats)
                    .map(([mark, count]) => ({ mark: parseInt(mark), count }))
                    .sort((a, b) => Math.abs(b.mark) - Math.abs(a.mark));

                // 创建图例项
                sortedMarks.forEach(({ mark, count }) => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    
                    const color = document.createElement('div');
                    color.className = 'legend-color';
                    color.style.backgroundColor = this.getMarkerColor(mark);
                    
                    const text = document.createElement('span');
                    text.textContent = `${mark > 0 ? '上涨' : '下跌'}${Math.abs(mark)}%`;
                    
                    const countSpan = document.createElement('span');
                    countSpan.className = 'legend-count';
                    countSpan.textContent = `(${count}个)`;
                    
                    item.appendChild(color);
                    item.appendChild(text);
                    item.appendChild(countSpan);
                    legend.appendChild(item);
                });
            }

            async loadData() {
                try {
                    // 从本地文件加载数据
                    const response = await fetch('/cache/kline_data_marked.json');
                    if (!response.ok) {
                        throw new Error('获取数据失败');
                    }
                    const rawData = await response.json();

                    // 将对象格式转换为数组
                    const data = Object.entries(rawData).map(([timestamp, item]) => ({
                        timestamp: parseInt(timestamp),
                        ...item
                    }));

                    // 按时间排序
                    const sortedData = data.sort((a, b) => a.timestamp - b.timestamp);

                    // 处理K线数据
                    const candleData = sortedData.map(item => ({
                        time: Math.floor(item.timestamp / 1000),
                        open: parseFloat(item.open),
                        high: parseFloat(item.high),
                        low: parseFloat(item.low),
                        close: parseFloat(item.close)
                    }));

                    // 处理成交量数据
                    const volumeData = sortedData.map(item => ({
                        time: Math.floor(item.timestamp / 1000),
                        value: parseFloat(item.volume),
                        color: parseFloat(item.close) >= parseFloat(item.open) ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
                    }));

                    // 统计标记
                    this.markStats = {};
                    sortedData.forEach(item => {
                        if (item.mark !== 0) {
                            this.markStats[item.mark] = (this.markStats[item.mark] || 0) + 1;
                        }
                    });

                    // 处理标记数据
                    const markers = sortedData
                        .filter(item => item.mark !== 0)
                        .map(item => ({
                            time: Math.floor(item.timestamp / 1000),
                            position: 'aboveBar',
                            color: this.getMarkerColor(item.mark),
                            shape: 'circle',
                            text: item.mark.toString() + '%',
                            size: Math.min(Math.max(Math.abs(item.mark) / 5, 1), 3)  // 根据变动幅度调整标记大小
                        }));

                    // 设置数据
                    this.candlestickSeries.setData(candleData);
                    this.volumeSeries.setData(volumeData);
                    this.candlestickSeries.setMarkers(markers);

                    // 更新图例
                    this.updateLegend();

                    // 调整视图
                    this.chart.timeScale().fitContent();

                } catch (error) {
                    console.error('加载数据失败:', error);
                }
            }

            handleResize() {
                const container = document.getElementById('chart');
                this.chart.applyOptions({
                    width: container.clientWidth,
                    height: container.clientHeight
                });
            }
        }

        // 当页面加载完成时初始化图表
        document.addEventListener('DOMContentLoaded', () => {
            const chart = new MarkedChart();
            chart.initialize();
        });
    </script>
</body>
</html>
